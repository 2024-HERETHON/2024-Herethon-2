{% extends "base.html" %} {% load static %} {% block content %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% if folder %}{{ path }}{% else %}Stuck{% endif %}</title>
    <link rel="stylesheet" href="{% static 'css/view_folder.css' %}" />
</head>
<body>
    <main class="folder_main">
<!-- 조회화면 상단부: 폴더명, 삭제하기, 저장 및 검색창 -->
        <section class="top">
            <div class="top-left">
                <div class="title">
                <a href="{% url 'quiz:home' %}"><img class="left_allow" src="{% static 'img/left_allow.png' %}" /></a>
                <h4>MY STUCK</h4>
                </div>
                <div class="detail">
                    <div class="scrap">
                        <img class="icon_scrap" src="{% static 'img/icon_scrap.svg' %}" />
                        <p>폴더 즐겨찾기에 저장</p>
                    </div>
                    <div class="search">
                        <img class="icon_search" src="{% static 'img/icon_scrap.svg' %}" />
                        <p>찾고 싶은 파일과 문서를 검색하세요</p>
                    </div>
                </div> 
            </div>
            <div class="top-right">
                <img class="icon_delete" src="{% static 'img/icon_delete.png' %}" />
                <div>
                    <h5>삭제하기</h5>
                    <p>삭제할 폴더와 문서를 여기로 드래그</p>
                </div>
            </div>
        </section>
<!-- 저장할 폴더 정하는 박스 -->  
        
<!-- 폴더 이미지 + 폴더명 -->
        <section class="myfolders">
            <div class="folder_frame1">
                <img class="folder_image1" src="{% static 'img/folder_shadow.svg' %}" />
                <p>폴더명(선택된 경우)</p>
            </div>
            <div class="folder_frame2">
                <img class="folder_image2" src="{% static 'img/folder.svg' %}" />
                <p>폴더명(선택 안 된 경우)</p>
            </div> 
            <div class="folder_frame3">
                <img class="q" src="{% static  'img/q.png' %}" />
                <p>파일명(문제)</p> 
            </div>
            <div class="folder_frame4">
                <img class="t" src="{% static 'img/t.png' %}" />
                <p>파일명(텍스트?)</p>
            </div> 
            <div class="folder_frame5">
                <img class="txt" src="{% static 'img/txt.png' %}" />
                <p>파일명(요약본?)</p>
            </div> 
        </section>
<!-- 폴더 이미지 + 폴더명 -->
        

        
    </main>

    <a href="{% url 'quiz:home' %}">홈으로</a>
    <h1>{% if folder %}{{ path }}{% else %}Stuck{% endif %}</h1>

    {% if folder %}
        {% if not folder in request.user.customuser.scrap_folders.all %}
        <a href="{% url 'quiz:add-scrap-folder' folder_id=folder.id %}">스크랩</a>
        {% else %}
        <a href="{% url 'quiz:cancel-scrap-folder' folder_id=folder.id %}">스크랩 취소</a>
        {% endif %}
    {% endif %}

    <div id="trash-bin">쓰레기통</div>

    <h3>folder</h3>
    <ul ondrop="drop(event, {% if folder %}{{ folder.id }}{% else %}0{% endif %})" ondragover="allowDrop(event)">
        {% for child in children %}
            <li id="folder-{{ child.id }}" class="draggable" draggable="true">
                <a href="{% url 'quiz:folder-view' child.id %}">{{ child.name }}</a>
            </li>
        {% endfor %}
    </ul>

    <h3>quiz</h3>
    <ul ondragover="allowDrop(event)">
        {% for q in folder.quizs.all %}
            <li id="quiz-{{ q.id }}" class="draggable" draggable="true">
                <a id="quiz-{{ q.id }}" href="{% url 'quiz:view-questions' folder.id q.id %}">{{ q.title }}</a>
            </li>
        {% endfor %}
    </ul>

    <h3>q&a</h3>
    <ul ondragover="allowDrop(event)">
        {% for q in folder.qnas.all %}
            <li id="qna-{{ q.id }}" class="draggable" draggable="true">
                <a id="qna-{{ q.id }}" href="{% url 'qna:enter-question-room' folder.id q.id %}">{{ q.title }}</a>
            </li>
        {% endfor %}
    </ul>

    <br><br>
    {% if folder %}

        {% if folder.parent == None %}
            <a href="{% url 'quiz:folder-view' 0 %}">루트 폴더로 이동</a>
        {% else %}
            <a href="{% url 'quiz:folder-view' folder.parent.id %}">폴더 뒤로 가기</a>
        {% endif %}

    {% endif %}
    <br><br>

    <h3>즐겨찾기</h3>
    <ul>
        {% for scrap in scraps %}
            <li>{{ scrap.folder.name }} - <a href="{% url 'quiz:folder-view' folder_id=scrap.folder.id %}">폴더 보기</a></li>
        {% endfor %}
    </ul>

    <script>
        function drag(event) {
            console.log(event.target)
            console.log(event.target.href)
            event.dataTransfer.setData("text", event.target.id);
            console.log("Drag started: " + event.target.id);
        }

        function allowDrop(event) {
            event.preventDefault();
        }

        function drop(event, parentId) {
            event.preventDefault();
            var data = event.dataTransfer.getData("text");
            console.log(data)
            var test = data.split('-')[0];
            console.log(`test ${test}`);

            if (test === "quiz") {
                var quizId = data.split('-')[1];
                var targetElement = event.target.closest('li');
                var newCategoryId = targetElement ? targetElement.id.split('-')[1] : '0';
                var currentUrl = window.location.href;
                var categoryId = currentUrl.match(/folder\/(\d+)\//)[1];
                window.location.href = `/quiz/move/${categoryId}/${quizId}/to/${newCategoryId}/`;
            } else if (test === "qna") {
                var qnaId = data.split('-')[1];
                var targetElement = event.target.closest('li');
                var currentFolderId = targetElement ? targetElement.id.split('-')[1] : '0';
                var currentUrl = window.location.href;
                var moveFolderId = currentUrl.match(/folder\/(\d+)\//)[1];
                window.location.href = `/qna/move/${currentFolderId}/${qnaId}/to/${moveFolderId}/`;
            } else {
                    var categoryId = data.split('/')[4];
                    // 드롭한 위치의 가장 가까운 li 요소 찾기
                    var targetElement = event.target.closest('li'); 
                    // 부모 ID 추출
                    var parentId = targetElement ? targetElement.id.split('-')[1] : '0'; 
                    console.log(data)
                    console.log(categoryId)
                    // 생성한 폴더 이동
                    window.location.href = `/folder/move/${categoryId}/to/${parentId}/`;
                }
        }

        document.querySelectorAll('.draggable').forEach(function(element) {
            element.addEventListener('dragstart', drag);
        });

        var trashBin = document.getElementById('trash-bin');
        trashBin.addEventListener('dragover', function(event) {
            event.preventDefault();
            trashBin.classList.add('dragover');
        });
        trashBin.addEventListener('dragleave', function(event) {
            trashBin.classList.remove('dragover');
        });
        trashBin.addEventListener('drop', function(event) {
            dropToTrash(event);
        });

        function dropToTrash(event) {
            event.preventDefault();
            var data = event.dataTransfer.getData("text");
            var test = data.split('-')[0];
            var itemId = data.split('-')[1];
            console.log(test)

            if (test === "quiz") {
                window.location.href = `/quiz/delete/${itemId}/`;
            } else if (test === "qna") {
                window.location.href = `/qna/delete/${itemId}/`;
            } else {
                var itemId = data.split('/')[4];
                window.location.href = `/folder/delete/${itemId}/`;
            }
        }
    </script>
</body>
{% endblock %}
</html>
